# Ark UI v3.5.0 から v5.13.0 へのアップグレード計画

このドキュメントは、Ark UI のバージョンを v3.5.0 から v5.13.0 へアップグレードするための計画と、これまでの調査結果をまとめたものです。

## Ark UI アップグレードタスクリスト

### フェーズ1: 準備・調査

1.  **リリースノートの精査:**
    *   [x] Ark UIの公式Changelogページで、`v3.5.0`から最新の`v5.13.0`までのすべてのリリースノートを確認しました。
    *   [x] 特に`v4.0.0`と`v5.0.0`のメジャーアップデートに注目し、「Breaking Changes」の項目をすべてリストアップしました。
    *   [x] コンポーネントAPIの変更（プロパティ名、構造、インポートパスの変更など）を重点的にメモしました。
    *   [x] スタイリング（Panda CSS連携）に関する変更がないか確認しました。

2.  **影響範囲の再確認:**
    *   [x] プロジェクト内の全コンポーネント（`Accordion`, `Avatar`, `CheckBox`, `Drawer`, `DropdownMenu`, `ModalDialog`, `Pagination`, `RadioButton`, `Search`, `Select`, `Switch`, `Tabs`, `Toast`）が、リストアップした破壊的変更の影響を受けるか確認しました。

3.  **現状の記録:**
    *   [ ] `git`で新しいブランチを作成し、作業を開始します。(例: `feat/upgrade-ark-ui`)
    *   [ ] （推奨）ChromaticなどのVisual Regression Testingツールを使っている場合、現在のUI状態のスナップショットを生成しておきます。ない場合は、主要なコンポーネントのStorybookページを手動でスクリーンショット撮影し、変更前後の比較ができるようにしておきます。

### フェーズ2: アップグレードとコード修正

4.  **依存関係の更新:**
    *   [ ] `package.json`を開き、`@ark-ui/react`のバージョンを`^3.5.0`から`^5.13.0`に書き換えます。
    *   [ ] ターミナルで `npm install` (または `yarn install`, `pnpm install`) を実行し、新しいバージョンをインストールします。

5.  **コンパイルエラーの解消:**
    *   [ ] `npm run build` または `tsc --noEmit` を実行し、型エラーを検出します。
    *   [ ] フェーズ1で調査した破壊的変更のリストを元に、型エラーが出なくなるまで、影響を受けるすべてのコンポーネントファイルを一つずつ修正します。
        *   *例: プロパティ名の変更 (`isOpen` -> `open`)、コンポーネント構造の変更 (`<Menu.Trigger>` -> `<Menu.Trigger asChild>`) などに対応します。*

6.  **Panda CSS設定の確認:**
    *   [ ] `panda.config.ts` を確認し、Ark UIのレシピや設定に変更が必要ないか確認します。リリースノートでスタイリングに関する言及があった場合は、特に注意深く確認し、必要であれば設定を更新します。

### フェーズ3: 検証

7.  **ビルドと型チェック:**
    *   [ ] `npm run build` を再度実行し、プロジェクト全体がエラーなくビルドできることを確認します。

8.  **Storybookでの視覚的・動作確認:**
    *   [ ] `npm run storybook` を実行し、Storybookを起動します。
    *   [ ] 影響を受けたすべてのコンポーネントについて、以下の点を確認します。
        *   **表示崩れ:** フェーズ1で記録したスナップショットやスクリーンショットと比較し、意図しない表示の崩れがないか確認します。
        *   **インタラクション:** クリック、ホバー、フォーカス、キーボード操作などがすべて正しく機能するか確認します。
        *   **コンソールエラー:** ブラウザの開発者ツールを開き、コンソールにエラーや警告が表示されていないか確認します。

9.  **自動テストの実行:**
    *   [ ] `npm run test` を実行し、既存のすべてのテストがパスすることを確認します。失敗したテストがあれば、コンポーネントの変更に合わせてテストコードを修正します。

### フェーズ4: クリーンアップ

10. **コードレビューとリファクタリング:**
    *   [ ] アップグレードに伴い不要になった古いコード（カスタムラッパー、古いスタイルの定義など）を削除します。
    *   [ ] 変更箇所全体を見直し、より新しいAPIの作法に沿った、クリーンなコードになっているか確認します。

11. **プルリクエストの作成:**
    *   [ ] 変更内容をまとめたプルリクエストを作成し、チームにレビューを依頼します。変更の経緯と、確認してほしい点を明確に記述します。

---

## 影響範囲の分析結果

これまでの調査で、`src/components` 以下の複数のコンポーネントで Ark UI が使用されていることが判明しました。特に以下の破壊的変更が影響を及ぼす可能性があります。

### 【最重要】v5.0.0 の破壊的変更

*   **パフォーマンスと内部実装の刷新:**
    *   **内容:** 状態管理ライブラリ `zustand` への依存をなくし、Reactのネイティブな機能（Context, State）を利用するようになりました。これにより、パフォーマンスが大幅に向上（1.5倍〜4倍）し、React Server Components (RSC) との互換性が向上しました。
    *   **影響:** これは内部的な変更が主ですが、一部のコンポーネントの挙動や、高度な使い方をしている場合に影響が出る可能性があります。APIの使い方が変わっている可能性があるため、各コンポーネントのドキュメントを再確認しながらのアップグレードが必須です。

*   **`asChild` プロパティの導入:**
    *   **内容:** 多くのコンポーネントパーツ（例: `Accordion.Trigger`, `Button`, `Menu.Trigger`など）で、`asChild` プロパティが導入されました。これにより、Ark UIのコンポーネントを独自のカスタムコンポーネントや `styled` コンポーネントでラップする際の柔軟性が向上しました。
    *   **影響:** これまで `children` として渡していたカスタムコンポーネントが正しく動作しなくなる可能性があります。`asChild` を適切に使用するようにコードを修正する必要があります。これは広範囲に影響する可能性が高いです。

### v4.0.0 の破壊的変更

*   **コンポーネントAPIの変更:**
    *   **`Combobox`:** `items` プロパティの型が変更され、より柔軟なデータ構造を受け入れられるようになりました。
    *   **`Pagination`:** `Pagination`コンポーネントが `@ark-ui/react` の本体からサブパス `@ark-ui/react/pagination` に移動しました。
    *   **`Editable`:** `onValueChange` の引数が変更されました。
    *   **`PinInput`:** `onValueChange` の引数が変更されました。

### 個別コンポーネントへの影響分析

#### 1. `Pagination` コンポーネント

*   **ファイル:** `src/components/Pagination/Pagination.tsx`
*   **現在のコード:**
    ```typescript
    import { Pagination as ArkPagination } from "@ark-ui/react/pagination";
    ```
*   **分析:**
    このコンポーネントは、すでに `v4.0.0` で変更されたサブパス (`@ark-ui/react/pagination`) からインポートしています。
*   **影響:**
    `v4.0.0` の破壊的変更であるインポートパスの変更については、**すでに対応済み**です。したがって、この点に関する修正は不要です。ただし、`v5.0.0` 以降の `Pagination` コンポーネント自体のAPI（プロパティなど）に変更がないかは、別途確認が必要です。

#### 2. `Search` (Combobox) コンポーネント

*   **ファイル:** `src/components/Search/Search.tsx`
*   **現在のコード:**
    ```typescript
    import { Combobox, ComboboxRootProps, Portal } from "@ark-ui/react";
    // ...
    <Combobox.Root items={items} ...>
    ```
*   **分析:**
    `v4.0.0` のリリースノートで `Combobox` の `items` プロパティの型が変更されたとありました。現在のコードでは `items` は `string[]` として渡されています。`v5` のドキュメントを確認し、この `items` の扱い方（特にオブジェクトの配列を渡す場合など）に変更がないか、アップグレード時に注意深く確認する必要があります。
*   **影響:**
    `items` プロパティの仕様変更による影響を受ける可能性があります。アップグレード後、`Combobox` が正しく候補を表示・フィルタリングできるか、Storybookでの動作確認が必須です。

#### 3. `Accordion` コンポーネントと `asChild` プロパティ

*   **ファイル:** `src/components/Accordion/Accordion.tsx`
*   **現在のコード:**
    ```tsx
    <ArkAccordion.ItemTrigger className={styles.item}>
      <span className={styles.title}>{title}</span>
      <ArkAccordion.ItemIndicator className={styles.itemIndicator}>
        <SerendieSymbolChevronDown className={styles.icon} />
      </ArkAccordion.ItemIndicator>
    </ArkAccordion.ItemTrigger>
    ```
*   **分析:**
    `v5.0.0` で導入された `asChild` プロパティは、Ark UIのコンポーネントパーツ（例: `ItemTrigger`）が、その子要素に自身のプロパティをマージするためのものです。現在の `Accordion` の実装では、`ItemTrigger` の子要素として `span` や `ItemIndicator` が直接配置されています。`v5.0.0` 以降、このような構造が意図通りに動作しなくなる可能性があります。
*   **影響:**
    これは**破壊的変更の影響を直接受ける可能性が高い**箇所です。アップグレード後、アコーディオンの開閉が機能しなくなる、あるいはスタイルが正しく適用されなくなることが予想されます。`v5` のドキュメントに従い、`asChild` を使うか、あるいは新しい作法に沿ったコンポーネント構造に修正する必要があります。このパターンは `Button`, `DropdownMenu`, `ModalDialog` のトリガー部分など、プロジェクト内の他の多くのコンポーネントにも共通している可能性が高いです。
